<!DOCTYPE html>
<html>

<head>
  <title>Just扫雷</title>
  <style>
    #tool {
      width: 100%;
      height: 50px;
    }
    #state {
      font-weight: bold;
      color: red;
    }
    table {
      border-spacing: 0;
    }

    td {
      box-sizing: border-box;
      background: lightgray;
      border: 1px solid gray;
      text-align: center;
      vertical-align: middle;
    }

    td.normal {
      border-left: 2px solid #ededed;
      border-top: 2px solid #ededed;
      border-right: 2px solid gray;
      border-bottom: 2px solid gray;
    }

    td.normal:hover {
      border-left: 2px solid gray;
      border-top: 2px solid gray;
      border-right: 2px solid #ededed;
      border-bottom: 2px solid #ededed;
    }

    td.mark {
      font-weight: bold;
      border-left: 2px solid #ededed;
      border-top: 2px solid #ededed;
      border-right: 2px solid gray;
      border-bottom: 2px solid gray;
    }
    td.mark.flag::after {
      color: red;
      content: '!';
    }
    td.mark.nosure::after {
      content: '?';
    }

    td.number {
      font-weight: bold;
    }

    td.number.d1 {
      color: blue;
    }

    td.number.d2 {
      color: green;
    }

    td.number.d3 {
      color: red;
    }

    td.number.d4 {
      color: darkblue;
    }

    td.number.d5 {
      color: darkred;
    }

    td.number.d6 {
      color: darkcyan;
    }

    td.number.d7 {
      color: black;
    }

    td.number.d8 {
      color: gray;
    }

    td.mine::after {
      content: '✪'
    }
    td.mine.boom {
      color: red;
    }
  </style>
</head>

<body>
  <div id="parent">
    <div id="tool">
      <input type="radio" name="action" id="openAction" value="open" checked/>翻开
      <input type="radio" name="action" id="markAction" value="mark"/>标记
      <span id="state"></span>
    </div>
    <div id="game"></div>
  </div>
  <script type="text/javascript">
    var classNames = {
      normal: 'normal',
      number: 'number',
      mine: 'mine',
      boom: 'boom',
      mark: 'mark',
      flag: 'mark flag',
      nosure: 'mark nosure'
    };
    var states = {
      loading: '加载中...',
      newGame: '新游戏',
      playing: '游戏中',
      win: '胜利！',
      fail: '失败！'
    }
    var options = {
      mineSize: 30,
      cells: [],
      mines: [],
      state: states.loading,
      opens: [],
      stateElem: null
    };
    var settings = {
      hCount: 9,
      vCount: 9,
      mCount: 10
    };

    var setState = function(state) {
      options.state = state;
      options.stateElem.innerText = state;
    }

    var newGame = function () {
      options.stateElem = document.getElementById('state');
      setState(states.loading);
      options.mines = [];
      options.cells = [];
      options.opens = [];

      var game = document.getElementById("game");
      var table = document.createElement('table');
      var cellIndex = 0;
      for (let r = 0; r < settings.vCount; r++) {
        var tr = document.createElement('tr');
        tr.id = "tr" + r;
        for (let c = 0; c < settings.hCount; c++) {
          var td = document.createElement('td');
          td.id = "td" + ++cellIndex;
          td.style.width = options.mineSize + "px";
          td.style.height = options.mineSize + "px";
          td.className = classNames.normal;
          td.setAttribute('n', cellIndex);
          td.onclick = leftClick;
          tr.appendChild(td);
          options.cells.push(cellIndex);
        }
        table.appendChild(tr);
      }
      game.innerHTML = "";
      game.appendChild(table);

      setState(states.newGame);
    }

    var setMines = function (startPoint) {
      console.debug('setMines:' + startPoint);
      setState(states.loading);

      options.mines = [];
      var cells = options.cells.concat();
      while(options.mines.length < settings.mCount) {
        var index = randomInt(0, cells.length - 1);
        var cell = cells[index];
        cells.splice(index, 1);
        if(!startPoint || cell !== startPoint)
          options.mines.push(cell);
      }

      setState(states.playing);
    }

    var leftClick = function($event){
      if(options.state !== states.newGame && options.state !== states.playing) {
        newGame();
        return;
      }
      var cell = Number($event.srcElement.getAttribute('n'));
      var action = document.getElementById('markAction');
      if(action.checked){
        mark($event.srcElement);
      } else {
        open(cell);
      }
    }
    var mark = function(elem) {
      if(elem.className === classNames.flag){
        elem.className = classNames.nosure;
      } else if(elem.className === classNames.nosure) {
        elem.className = classNames.normal;
      } else {
        elem.className = classNames.flag;
      }
    }
    var open = function (cell) {
      console.debug('open:' + cell);
      var elem = document.getElementById('td' + cell);
      if(!elem) return;
      if (elem.className === classNames.normal) {
        checkStart(cell);
        options.opens.push(cell);
        var count = getMineCount(cell);
        if(count < 0){
          gameOver(cell);
          return;
        } else if (count === 0){
          elem.className = classNames.number;
          var around = getAroundCells(cell);
          for (let i = 0; i < around.length; i++) {
            open(around[i]);
            if(options.state !== states.playing) return;
          }
        } else if (!!count) {
          elem.className = classNames.number + " d" + count;
          elem.innerHTML = count;
        }
        checkWin();
      }
    }
    var checkStart = function(startPoint) {
      if(options.state === states.newGame){
        setMines(startPoint);
      }
    }
    var checkWin = function() {
      if(options.state !== states.playing) return false;
      if(options.opens.length + settings.mCount === options.cells.length) {
        setState(states.win);
        return true;
      }
      return false;
    }
    var getMineCount = function(cell){
      if(options.mines.indexOf(cell) >=0) return -1;

      var count = 0;
      var around = getAroundCells(cell);
      for (let i = 0; i < around.length; i++) {
        if(options.mines.indexOf(around[i]) >= 0) count++;
      }
      return count;
    }
    var getAroundCells = function(cell){
      var around = [];
      var row = cell / settings.hCount;
      var col = cell % settings.hCount;
      if(row > 1){
        around.push(cell - settings.hCount);
        if(col > 1)
          around.push(cell - settings.hCount - 1);
        if(col < settings.hCount)
          around.push(cell - settings.hCount + 1);
      }
      if(col > 1)
        around.push(cell - 1);
      if(col < settings.hCount)
        around.push(cell + 1);
      if(row < settings.vCount) {
        around.push(cell + settings.hCount);
        if(col > 1)
          around.push(cell + settings.hCount - 1);
        if(col < settings.hCount)
          around.push(cell + settings.hCount + 1);
      }
      return around;
    }
    var gameOver = function(cell) {
      setState(states.loading);

      for (let i = 0; i < options.mines.length; i++) {
        var index = options.mines[i];
        var elem = document.getElementById('td' + index);
        elem.className = classNames.mine;
        if(index === cell) elem.className += " " + classNames.boom;
      }

      setState(states.fail);
    }

    var randomInt = function (min, max) {
      switch (arguments.length) {
        case 1:
          return parseInt(Math.random() * min + 1, 10);
          break;
        case 2:
          return parseInt(Math.random() * (max - min + 1) + min, 10);
          break;
        default:
          return 0;
          break;
      }
    }

    document.onload = newGame();
  </script>
</body>

</html>

<!--around边界 newgame-->