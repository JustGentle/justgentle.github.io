<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½®å€¼ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            position: relative;
        }
        
        header {
            background: linear-gradient(90deg, #2c3e50, #1a2980);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* ä»Šæ—¥å€¼æ—¥åŒºåŸŸ */
        .today-duty-section {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
            padding: 25px;
            text-align: center;
            border-bottom: 3px solid #f1c40f;
        }
        
        .today-duty-content {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .today-title {
            font-size: 1.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .today-info {
            font-size: 1.4rem;
            font-weight: 600;
            background: white;
            color: #e74c3c;
            padding: 12px 30px;
            border-radius: 50px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            min-width: 200px;
            text-align: center;
        }
        
        .today-date {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* å€¼æ—¥è¡¨åŒºåŸŸ */
        .duty-calendar {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .calendar-title {
            font-size: 1.8rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .date-range {
            color: #7f8c8d;
            font-weight: 500;
            font-size: 1.1rem;
        }
        
        .duty-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .day-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            min-height: 160px;
            position: relative;
            overflow: hidden;
        }
        
        .day-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        
        .day-card.today {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .day-card.weekend {
            background: #fff9e6;
        }
        
        .day-card.holiday {
            background: #ffeef0;
        }
        
        .day-card.off-day {
            background: #f4f4f4;
            opacity: 0.7;
        }
        
        .day-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .day-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .day-date {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .duty-info {
            margin-top: 10px;
        }
        
        .duty-person {
            font-weight: 600;
            font-size: 1.1rem;
            color: #e74c3c;
            margin: 5px 0;
        }

        .day-card.past .duty-person {
            color: #7f8c8d;
        }
        
        .duty-status {
            font-size: 0.85rem;
            padding: 4px 8px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 5px;
        }
        
        .duty-status.working {
            background: #d5f5e3;
            color: #27ae60;
        }
        
        .duty-status.rest {
            background: #fadbd8;
            color: #c0392b;
        }
        
        .duty-status.special {
            background: #ebdef0;
            color: #8e44ad;
        }
        
        /* æ§åˆ¶é¢æ¿åŒºåŸŸ */
        .control-panel {
            background: #f8f9fa;
            padding: 30px;
            border-top: 3px solid #3498db;
        }
        
        .panel-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }
        
        .panel-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        
        .setting-group {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .setting-title {
            font-weight: 600;
            margin-bottom: 20px;
            color: #34495e;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
        }
        
        .setting-item {
            margin-bottom: 20px;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #7f8c8d;
        }
        
        .setting-value {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c3e50;
            padding: 8px 0;
        }
        
        .week-display {
            background: #f0f7ff;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            margin-top: 10px;
        }
        
        .members-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: .5em;
        }
        
        .members-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .members-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .members-list::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 10px;
        }
        
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            border: 1px solid #eee;
            white-space: nowrap;
        }
        
        .member-item:hover {
            background: #f9f9f9;
        }
        
        .member-details {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .member-order {
            background: #3498db;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .member-name {
            flex: 1;
            font-weight: 500;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .today-color {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .holiday-color {
            background: #ffeef0;
        }
        
        .weekend-color {
            background: #fff9e6;
        }
        
        .off-day-color {
            background: #f4f4f4;
        }
        
        .instructions {
            line-height: 1.8;
        }
        
        .instructions p {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .instructions i {
            color: #3498db;
            min-width: 20px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 1000;
        }
        
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 900px) {
            .duty-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .duty-grid {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            .calendar-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .panel-content {
                grid-template-columns: 1fr;
            }
            
            .today-info {
                font-size: 1.2rem;
                padding: 10px 20px;
            }
            
            .read-only-banner {
                top: 15px;
                right: -35px;
                font-size: 0.9rem;
                padding: 8px 35px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <h2>æ­£åœ¨åŠ è½½é…ç½®æ–‡ä»¶...</h2>
    </div>
    
    <div class="container">
        <header>
            <h1>ğŸ“… è½®å€¼ç³»ç»Ÿ</h1>
            <p class="subtitle">é…ç½®æ–‡ä»¶é©±åŠ¨ â€¢ è‡ªåŠ¨è·³è¿‡èŠ‚å‡æ—¥ â€¢ å¤§å°å‘¨</p>
        </header>
        
        <!-- ä»Šæ—¥è½®å€¼åŒºåŸŸ -->
        <section class="today-duty-section">
            <div class="today-duty-content">
                <div class="today-title">
                    â­
                    <span>ä»Šæ—¥è½®å€¼å®‰æ’</span>
                </div>
                <div class="today-info" id="todayDutyPerson">åŠ è½½ä¸­...</div>
                <div class="today-date" id="todayDate">2025å¹´8æœˆ13æ—¥ æ˜ŸæœŸä¸‰</div>
            </div>
        </section>
        
        <!-- è½®å€¼è¡¨åŒºåŸŸ -->
        <div class="duty-calendar">
            <div class="calendar-header">
                <h2 class="calendar-title">ğŸ“… è½®å€¼å®‰æ’è¡¨</h2>
                <div class="date-range" id="dateRange">2025å¹´8æœˆ6æ—¥ - 2025å¹´8æœˆ20æ—¥</div>
            </div>
            
            <div class="duty-grid" id="dutyGrid">
                <!-- è½®å€¼è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color today-color"></div>
                    <span>ä»Šå¤©</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color weekend-color"></div>
                    <span>å‘¨æœ«</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color holiday-color"></div>
                    <span>èŠ‚å‡æ—¥</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color off-day-color"></div>
                    <span>ä¼‘æ¯æ—¥</span>
                </div>
            </div>
        </div>
        
        <!-- é…ç½®åŒºåŸŸ -->
        <div class="control-panel">
            <h2 class="panel-title">âš™ï¸ é…ç½®ä¿¡æ¯</h2>
            
            <div class="panel-content">
                <div class="setting-group">
                    <h3 class="setting-title">ğŸ“… è½®å€¼è®¾ç½®</h3>
                    
                    <div class="setting-item">
                        <div class="setting-label">è½®å€¼èµ·å§‹æ—¥æœŸ</div>
                        <div class="setting-value" id="startDateDisplay">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">æœ¬å‘¨å·¥ä½œæ¨¡å¼</div>
                        <div class="setting-value" id="currentWeekType">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-label">è½®å€¼æ˜¾ç¤ºèŒƒå›´</div>
                        <div class="setting-value" id="displayDays">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <div class="setting-title" style="margin-top: 25px;">
                        ğŸ‘¥ è½®å€¼æˆå‘˜åˆ—è¡¨
                    </div>
                    <div class="members-list" id="membersList">
                        <!-- æˆå‘˜åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="setting-group">
                    <h3 class="setting-title">â„¹ï¸ ç³»ç»Ÿè¯´æ˜</h3>
                    <div class="instructions">
                        <p>âœ… æ­¤ç³»ç»Ÿä¸ºåªè¯»æ¨¡å¼ï¼Œé…ç½®æ¥è‡ªduty.jsonæ–‡ä»¶</p>
                        <p>âœ… æ˜¾ç¤ºèŒƒå›´ï¼šå½“å‰æ—¥æœŸå‰åNå¤©è½®å€¼å®‰æ’</p>
                        <p>âœ… è½®å€¼å®‰æ’åŸºäºèµ·å§‹æ—¥æœŸå’Œæˆå‘˜é¡ºåº</p>
                        <p>âœ… èŠ‚å‡æ—¥å’Œä¼‘æ¯æ—¥è‡ªåŠ¨è·³è¿‡ä¸è½®å€¼</p>
                        <p>âœ… æ”¯æŒå¤§å°å‘¨å·¥ä½œåˆ¶</p>
                        <p>âœ… è½®å€¼äººå‘˜æŒ‰ç…§é…ç½®é¡ºåºè½®æµå€¼æ—¥</p>
                        <p>âœ… ä»Šæ—¥è½®å€¼äººå‘˜åœ¨é¡¶éƒ¨é†’ç›®ä½ç½®æ˜¾ç¤º</p>
                    </div>
                    
                    <div class="setting-title" style="margin-top: 25px;">
                        ğŸ“… èŠ‚å‡æ—¥æ•°æ®æ¥æº
                    </div>
                    <p style="margin-top: 15px; color: #7f8c8d;">
                        â„¹ï¸ <a href="https://timor.tech/api/holiday">https://timor.tech/api/holiday</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç³»ç»ŸçŠ¶æ€
        let state = null;
        
        // åˆå§‹åŒ–å‡½æ•°
        async function init() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();
            
            try {
                // ä» duty.json åŠ è½½é…ç½®
                const response = await fetch(`duty.json?v=${Date.now()}`);
                if (!response.ok) {
                    throw new Error('æ— æ³•åŠ è½½é…ç½®æ–‡ä»¶');
                }
                
                const config = await response.json();
                
                // åˆå§‹åŒ–çŠ¶æ€
                state = {
                    members: config.members || [],
                    workType: config.workType || 0,
                    startWeekType: config.startWeekType || 0,
                    startDate: new Date(config.startDate || new Date().setDate(new Date().getDate() - 7)),
                    beforeDays: config.beforeDays === undefined ? 3 : config.beforeDays,
                    afterDays: config.afterDays === undefined ? 7 : config.afterDays,
                    holidayData: config.holidayData
                };
                await loadHolidayData();
                
                // æ›´æ–°UI
                updateConfigDisplay();
                renderMembers();
                generateDutyRoster();
                updateTodayDuty();
                updateCurrentWeekType();
                updateDisplayDays();
                
            } catch (error) {
                console.error('åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥:', error);
                alert('åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥: ' + error.message);
            } finally {
                // éšè—åŠ è½½çŠ¶æ€
                hideLoading();
            }
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // åœ¨çº¿åŠ è½½èŠ‚å‡æ—¥æ•°æ®
        async function loadHolidayData() {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - state.beforeDays);
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + state.afterDays);
            for (let year = startDate.getFullYear(); year <= endDate.getFullYear(); year++) {
                if (!!state.holidayData[year]) continue;
                const holidayData = await fetchHolidayData(year);
                if (!state.holidayData) {
                    state.holidayData = {};
                }
                state.holidayData[year] = holidayData;
            }
        }
        
        function fetchHolidayData(year) {
            return fetch(`https://timor.tech/api/holiday/year/${year}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`æ— æ³•åœ¨çº¿åŠ è½½${year}å¹´èŠ‚å‡æ—¥æ•°æ®`);
                    }
                    return response.json();
                })
                .then(data => data.holiday);
        }

        // æ›´æ–°é…ç½®æ˜¾ç¤º
        function updateConfigDisplay() {
            if (!state) return;
            
            // æ˜¾ç¤ºèµ·å§‹æ—¥æœŸ
            const formattedStartDate = formatDate(state.startDate, true);
            if (state.workType === 0) {
                document.getElementById('startDateDisplay').textContent = formattedStartDate;
            } else {
                const weekTypeText = state.startWeekType === 0 ? 'åŒä¼‘å‘¨' : 'å•ä¼‘å‘¨';
                document.getElementById('startDateDisplay').textContent = `${formattedStartDate}ï¼ˆ${weekTypeText}ï¼‰`;
            }
        }
        
        // æ›´æ–°æœ¬å‘¨å·¥ä½œæ¨¡å¼æ˜¾ç¤º
        function updateCurrentWeekType() {
            if (!state) return;
            
            const weekTypeSpan = document.getElementById('currentWeekType');
            if (state.workType === 0) {
                weekTypeSpan.parentElement.querySelector('.setting-label').textContent = 'å·¥ä½œæ¨¡å¼';
                weekTypeSpan.textContent = 'åŒä¼‘å‘¨';
            }
            else {
                const today = new Date();
                const weekType = getWeekTypeForDate(today);
                weekTypeSpan.textContent = `å¤§å°å‘¨ï¼ˆ${weekType === 0 ? 'åŒä¼‘å‘¨' : 'å•ä¼‘å‘¨'}ï¼‰`;
            }
        }

        // æ›´æ–°è½®å€¼æ˜¾ç¤ºèŒƒå›´
        function updateDisplayDays() {
            if (!state) return;

            const beforeDays = state.beforeDays || 0;
            const afterDays = state.afterDays || 0;
            document.getElementById('displayDays').textContent = `å‰ ${beforeDays} å¤© ~ å ${afterDays} å¤©`;
        }

        // æ¸²æŸ“æˆå‘˜åˆ—è¡¨
        function renderMembers() {
            if (!state) return;
            
            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';
            
            if (state.members.length === 0) {
                membersList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">æš‚æ— æˆå‘˜</p>';
                return;
            }
            
            state.members.forEach((member, index) => {
                const memberElement = document.createElement('div');
                memberElement.className = 'member-item';
                memberElement.innerHTML = `
                    <div class="member-details">
                        <div class="member-order">${index + 1}</div>
                        <div class="member-name">${member}</div>
                    </div>
                `;
                membersList.appendChild(memberElement);
            });
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºå·¥ä½œæ—¥
        function isWorkDay(date, weekType) {
            if (!state) return false;
            
            const day = date.getDay(); // 0 = å‘¨æ—¥, 1 = å‘¨ä¸€, ..., 6 = å‘¨å…­
            const dateStr = formatDate(date);
            const monthDay = formatDate(date, false, true);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯èŠ‚å‡æ—¥
            const holidayInfo = getHolidayInfo(date.getFullYear(), monthDay);
            if (holidayInfo) {
                // å¦‚æœæ˜¯èŠ‚å‡æ—¥ï¼Œåˆ™ä¼‘æ¯
                if (holidayInfo.holiday) {
                    return false;
                } 
                // å¦‚æœæ˜¯è¡¥ç­ï¼Œåˆ™å·¥ä½œ
                else {
                    return true;
                }
            }
            
            // å‘¨æ—¥æ€»æ˜¯ä¼‘æ¯
            if (day === 0) {
                return false;
            }
            
            // å‘¨å…­ï¼šåŒä¼‘å‘¨ä¼‘æ¯ï¼Œå•ä¼‘å‘¨å·¥ä½œ
            if (day === 6) {
                return weekType === 1; // å•ä¼‘å‘¨è¿”å›trueï¼ˆå·¥ä½œï¼‰ï¼ŒåŒä¼‘å‘¨è¿”å›falseï¼ˆä¼‘æ¯ï¼‰
            }
            
            // å‘¨ä¸€åˆ°å‘¨äº”éƒ½æ˜¯å·¥ä½œæ—¥
            return true;
        }

        // è·å–å‡æ—¥ä¿¡æ¯
        function getHolidayInfo(year, monthDay) {
            const holiday = state.holidayData?.[year.toString()]?.holiday;
            if (!holiday) return null;
            return holiday[monthDay] || null;
        }

        // è·å–æŸæ—¥æœŸæ‰€åœ¨å‘¨çš„å‘¨ç±»å‹
        function getWeekTypeForDate(date) {
            if (!state) return 0;
            if (state.workType === 0) return 0; // å¦‚æœæ˜¯å›ºå®šåŒä¼‘åˆ™ç›´æ¥è¿”å›
            
            // è®¡ç®—èµ·å§‹æ—¥æœŸæ‰€åœ¨å‘¨çš„å‘¨ä¸€
            const startMonday = new Date(state.startDate);
            startMonday.setDate(state.startDate.getDate() - (state.startDate.getDay() || 7) + 1);
            
            // è®¡ç®—ç›®æ ‡æ—¥æœŸæ‰€åœ¨å‘¨çš„å‘¨ä¸€
            const targetMonday = new Date(date);
            targetMonday.setDate(date.getDate() - (date.getDay() || 7) + 1);
            
            // è®¡ç®—ä¸¤ä¸ªå‘¨ä¸€ä¹‹é—´çš„å‘¨æ•°å·®
            const timeDiff = targetMonday - startMonday;
            const diffWeeks = Math.floor(timeDiff / (1000 * 60 * 60 * 24 * 7));
            
            // æ ¹æ®å‘¨æ•°å·®å’Œèµ·å§‹å‘¨æ¨¡å¼è®¡ç®—ç›®æ ‡å‘¨æ¨¡å¼
            return (state.startWeekType + Math.abs(diffWeeks)) % 2;
        }

        // ç”Ÿæˆå€¼æ—¥è¡¨
        function generateDutyRoster() {
            if (!state) return;
            
            const dutyGrid = document.getElementById('dutyGrid');
            dutyGrid.innerHTML = '';
            
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - state.beforeDays);
            
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + state.afterDays);
            
            // æ›´æ–°æ—¥æœŸèŒƒå›´æ˜¾ç¤º
            document.getElementById('dateRange').textContent = 
                `${formatDate(startDate, true)} - ${formatDate(endDate, true)}`;
            
            // è·å–æ‰€æœ‰å·¥ä½œæ—¥
            const workDays = [];
            const currentDate = new Date(state.startDate);
            
            // ä»èµ·å§‹æ—¥æœŸå¼€å§‹ï¼Œæ‰¾åˆ°æ‰€æœ‰å·¥ä½œæ—¥ç›´åˆ°è¦†ç›–æ˜¾ç¤ºèŒƒå›´
            while (currentDate <= endDate) {
                const weekType = getWeekTypeForDate(currentDate);
                if (isWorkDay(currentDate, weekType)) {
                    workDays.push(new Date(currentDate));
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // ç”Ÿæˆæ—¥å†å¡ç‰‡
            const displayStart = new Date(today);
            displayStart.setDate(today.getDate() - state.beforeDays);
            
            for (let i = 0; i < state.beforeDays + state.afterDays; i++) {
                const date = new Date(displayStart);
                date.setDate(displayStart.getDate() + i);
                
                const weekType = getWeekTypeForDate(date);
                const day = date.getDay();
                const dateStr = formatDate(date);
                const monthDay = formatDate(date, false, true);
                const holidayInfo = getHolidayInfo(date.getFullYear(), monthDay);
                const isHoliday = holidayInfo && holidayInfo.holiday;
                const isToday = isSameDay(date, today);
                const isPast = date < today;
                
                let dayType = 'work';
                let status = 'å·¥ä½œæ—¥';
                let statusClass = 'working';
                let specialNote = '';
                
                // åˆ¤æ–­æ—¥æœŸç±»å‹
                if (holidayInfo) {
                    if (holidayInfo.holiday) {
                        dayType = 'holiday';
                        status = 'ä¼‘æ¯æ—¥';
                        statusClass = 'rest';
                        specialNote = `<div class="duty-status special">${holidayInfo.name}</div>`;
                    } else {
                        dayType = 'work';
                        status = 'å·¥ä½œæ—¥';
                        statusClass = 'working';
                        specialNote = `<div class="duty-status special">${holidayInfo.name}</div>`;
                    }
                } else if (day === 0 || (day === 6 && weekType === 0)) {
                    dayType = 'off';
                    status = 'ä¼‘æ¯æ—¥';
                    statusClass = 'rest';
                } else if (day === 6 && weekType === 1) {
                    dayType = 'work';
                    status = 'å·¥ä½œæ—¥';
                    statusClass = 'working';
                    specialNote = `<div class="duty-status special">å¤§å°å‘¨</div>`;
                }
                
                // è·å–å€¼æ—¥äººå‘˜ï¼ˆä»…å·¥ä½œæ—¥ï¼‰
                let dutyPerson = '-';
                if (dayType === 'work') {
                    // æ‰¾åˆ°è¯¥æ—¥æœŸåœ¨å·¥ä½œæ—¥æ•°ç»„ä¸­çš„ç´¢å¼•
                    const dayIndex = workDays.findIndex(d => isSameDay(d, date));
                    if (dayIndex !== -1 && state.members.length > 0) {
                        const memberIndex = dayIndex % state.members.length;
                        dutyPerson = state.members[memberIndex];
                    }
                }
                
                // åˆ›å»ºå¡ç‰‡
                const dayCard = document.createElement('div');
                dayCard.className = `day-card ${isToday ? 'today' : ''} ${isPast ? 'past' : ''} ${day === 0 || day === 6 ? 'weekend' : ''} ${isHoliday ? 'holiday' : ''} ${dayType === 'off' ? 'off-day' : ''}`;
                
                dayCard.innerHTML = `
                    <div class="day-header">
                        <div class="day-name">${getDayName(day)}</div>
                        <div class="day-date">${formatDate(date, true)}</div>
                    </div>
                    <div class="duty-info">
                        ${dayType === 'work' ? `<div class="duty-person">${dutyPerson}</div>` : ''}
                        <div class="duty-status ${statusClass}">${status}</div>
                        ${specialNote}
                    </div>
                `;
                
                dutyGrid.appendChild(dayCard);
            }
        }
        
        // æ›´æ–°ä»Šæ—¥å€¼æ—¥ä¿¡æ¯
        function updateTodayDuty() {
            if (!state) return;
            
            const today = new Date();
            const weekType = getWeekTypeForDate(today);
            const isWorkToday = isWorkDay(today, weekType);
            
            document.getElementById('todayDate').textContent = 
                `${formatDate(today, true)} ${getDayName(today.getDay())}`;
            
            if (isWorkToday) {
                // è·å–æ‰€æœ‰å·¥ä½œæ—¥
                const workDays = [];
                const currentDate = new Date(state.startDate);
                const todayEnd = new Date(today);
                todayEnd.setDate(today.getDate() + 1); // åŒ…å«ä»Šå¤©
                
                while (currentDate <= todayEnd) {
                    const weekType = getWeekTypeForDate(currentDate);
                    if (isWorkDay(currentDate, weekType)) {
                        workDays.push(new Date(currentDate));
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // æ‰¾åˆ°ä»Šå¤©åœ¨å·¥ä½œæ—¥ä¸­çš„ç´¢å¼•
                const dayIndex = workDays.findIndex(d => isSameDay(d, today));
                if (dayIndex !== -1 && state.members.length > 0) {
                    const memberIndex = dayIndex % state.members.length;
                    document.getElementById('todayDutyPerson').textContent = state.members[memberIndex];
                } else {
                    document.getElementById('todayDutyPerson').textContent = "ä»Šæ—¥ä¼‘æ¯";
                }
            } else {
                document.getElementById('todayDutyPerson').textContent = "ä»Šæ—¥ä¼‘æ¯";
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ—¥æœŸæ ¼å¼åŒ–
        function formatDate(date, withYear = false, monthDayOnly = false) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            
            if (monthDayOnly) {
                return `${month}-${day}`;
            }
            
            if (withYear) {
                return `${year}å¹´${month}æœˆ${day}æ—¥`;
            }
            return `${year}-${month}-${day}`;
        }

        // è¾…åŠ©å‡½æ•°ï¼šè·å–æ˜ŸæœŸåç§°
        function getDayName(day) {
            const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            return days[day];
        }

        // è¾…åŠ©å‡½æ•°ï¼šåˆ¤æ–­ä¸¤ä¸ªæ—¥æœŸæ˜¯å¦æ˜¯åŒä¸€å¤©
        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        // åˆå§‹åŒ–åº”ç”¨
        window.onload = init;
    </script>
</body>
</html>